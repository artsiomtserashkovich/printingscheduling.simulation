<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Walltime Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <table align = "center" id="table" border="1">
    </table>
    <canvas 
            id="tasks-dashboard" 
            width="1417" 
            height="708" 
            style="display: block; touch-action: none; user-select: none; -webkit-user-drag: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); height: 472px; width: 945px;"></canvas>

    <canvas
            id="printers-dashboard"
            width="1417"
            height="708"
            style="display: block; touch-action: none; user-select: none; -webkit-user-drag: none; -webkit-tap-highlight-color: rgba(0, 0, 0, 0); height: 472px; width: 945px;"></canvas>
    <script>
        const data = JSON.parse(
           '[{"jobId":1,"printerId":1,"incoming":2884,"scheduleTimeSlot":{"start":2884,"finish":7208},"executionTimeSlot":{"start":2884,"finish":7207}},{"jobId":2,"printerId":1,"incoming":172144,"scheduleTimeSlot":{"start":172144,"finish":181333},"executionTimeSlot":{"start":172144,"finish":181332}},{"jobId":3,"printerId":1,"incoming":46924,"scheduleTimeSlot":{"start":46924,"finish":63070},"executionTimeSlot":{"start":46924,"finish":63069}},{"jobId":4,"printerId":3,"incoming":141360,"scheduleTimeSlot":{"start":141360,"finish":154153},"executionTimeSlot":{"start":141360,"finish":154152}},{"jobId":5,"printerId":3,"incoming":60908,"scheduleTimeSlot":{"start":60908,"finish":75553},"executionTimeSlot":{"start":60908,"finish":75552}},{"jobId":6,"printerId":3,"incoming":90605,"scheduleTimeSlot":{"start":90605,"finish":109734},"executionTimeSlot":{"start":90605,"finish":109733}},{"jobId":7,"printerId":3,"incoming":29955,"scheduleTimeSlot":{"start":29955,"finish":56957},"executionTimeSlot":{"start":29955,"finish":56956}},{"jobId":8,"printerId":3,"incoming":153346,"scheduleTimeSlot":{"start":154154,"finish":193755},"executionTimeSlot":{"start":154153,"finish":193753}},{"jobId":9,"printerId":4,"incoming":48920,"scheduleTimeSlot":{"start":48920,"finish":75089},"executionTimeSlot":{"start":48920,"finish":75088}},{"jobId":10,"printerId":4,"incoming":104060,"scheduleTimeSlot":{"start":131946,"finish":165809},"executionTimeSlot":{"start":131945,"finish":165807}},{"jobId":11,"printerId":4,"incoming":89081,"scheduleTimeSlot":{"start":89081,"finish":131945},"executionTimeSlot":{"start":89081,"finish":131944}},{"jobId":12,"printerId":4,"incoming":157805,"scheduleTimeSlot":{"start":165810,"finish":225376},"executionTimeSlot":{"start":165808,"finish":225373}},{"jobId":13,"printerId":4,"incoming":172088,"scheduleTimeSlot":{"start":225377,"finish":287000},"executionTimeSlot":{"start":225374,"finish":286996}},{"jobId":14,"printerId":6,"incoming":11115,"scheduleTimeSlot":{"start":11115,"finish":81073},"executionTimeSlot":{"start":11115,"finish":81072}},{"jobId":15,"printerId":5,"incoming":56545,"scheduleTimeSlot":{"start":56545,"finish":140137},"executionTimeSlot":{"start":56545,"finish":140136}},{"jobId":16,"printerId":7,"incoming":38450,"scheduleTimeSlot":{"start":38450,"finish":136301},"executionTimeSlot":{"start":38450,"finish":136300}},{"jobId":17,"printerId":5,"incoming":95887,"scheduleTimeSlot":{"start":140138,"finish":275588},"executionTimeSlot":{"start":140137,"finish":275586}},{"jobId":18,"printerId":6,"incoming":68086,"scheduleTimeSlot":{"start":81074,"finish":213938},"executionTimeSlot":{"start":81073,"finish":213936}},{"jobId":19,"printerId":6,"incoming":97475,"scheduleTimeSlot":{"start":213939,"finish":361711},"executionTimeSlot":{"start":213937,"finish":361708}},{"jobId":20,"printerId":8,"incoming":35465,"scheduleTimeSlot":{"start":35465,"finish":136403},"executionTimeSlot":{"start":35465,"finish":136402}},{"jobId":21,"printerId":8,"incoming":61165,"scheduleTimeSlot":{"start":136404,"finish":253111},"executionTimeSlot":{"start":136403,"finish":253109}},{"jobId":22,"printerId":7,"incoming":77040,"scheduleTimeSlot":{"start":136302,"finish":340883},"executionTimeSlot":{"start":136301,"finish":340881}},{"jobId":23,"printerId":8,"incoming":107895,"scheduleTimeSlot":{"start":253112,"finish":403283},"executionTimeSlot":{"start":253110,"finish":403280}},{"jobId":24,"printerId":8,"incoming":135851,"scheduleTimeSlot":{"start":403284,"finish":565113},"executionTimeSlot":{"start":403281,"finish":565109}},{"jobId":25,"printerId":10,"incoming":7282,"scheduleTimeSlot":{"start":7282,"finish":106484},"executionTimeSlot":{"start":7282,"finish":106483}},{"jobId":26,"printerId":10,"incoming":138149,"scheduleTimeSlot":{"start":219147,"finish":327015},"executionTimeSlot":{"start":219145,"finish":327012}},{"jobId":27,"printerId":9,"incoming":116412,"scheduleTimeSlot":{"start":176907,"finish":317677},"executionTimeSlot":{"start":176906,"finish":317675}},{"jobId":28,"printerId":9,"incoming":33142,"scheduleTimeSlot":{"start":33142,"finish":176906},"executionTimeSlot":{"start":33142,"finish":176905}},{"jobId":29,"printerId":10,"incoming":68837,"scheduleTimeSlot":{"start":106485,"finish":219146},"executionTimeSlot":{"start":106484,"finish":219144}},{"jobId":30,"printerId":11,"incoming":37128,"scheduleTimeSlot":{"start":253977,"finish":401566},"executionTimeSlot":{"start":253976,"finish":401564}},{"jobId":31,"printerId":11,"incoming":117571,"scheduleTimeSlot":{"start":593891,"finish":751381},"executionTimeSlot":{"start":593888,"finish":751377}},{"jobId":32,"printerId":11,"incoming":84687,"scheduleTimeSlot":{"start":401567,"finish":593890},"executionTimeSlot":{"start":401565,"finish":593887}},{"jobId":33,"printerId":11,"incoming":30968,"scheduleTimeSlot":{"start":30968,"finish":253976},"executionTimeSlot":{"start":30968,"finish":253975}},{"jobId":34,"printerId":12,"incoming":117965,"scheduleTimeSlot":{"start":262320,"finish":463168},"executionTimeSlot":{"start":262319,"finish":463166}},{"jobId":35,"printerId":12,"incoming":22200,"scheduleTimeSlot":{"start":22200,"finish":262319},"executionTimeSlot":{"start":22200,"finish":262318}}]'
        )
        
        function generateTable(rawData)
        {
            function addHeaders(table) {
                const row = table.insertRow();
                row.insertCell().appendChild(document.createTextNode("job id"));
                row.insertCell().appendChild(document.createTextNode("printer id"));
                row.insertCell().appendChild(document.createTextNode("incoming"));
                row.insertCell().appendChild(document.createTextNode("scheduled start"));
                row.insertCell().appendChild(document.createTextNode("scheduled finish"));
                row.insertCell().appendChild(document.createTextNode("execution start"));
                row.insertCell().appendChild(document.createTextNode("execution finish"));
            }

            const table = document.getElementById('table');
            addHeaders(table);
            
            const tableData = rawData.sort((a,b) => a.jobId - b.jobId);
            
            tableData.forEach(record => {
                const row = table.insertRow();
                
                row.insertCell().appendChild(document.createTextNode(record.jobId));
                row.insertCell().appendChild(document.createTextNode(record.printerId));
                row.insertCell().appendChild(document.createTextNode(record.incoming));
                row.insertCell().appendChild(document.createTextNode(record.scheduleTimeSlot.start));
                row.insertCell().appendChild(document.createTextNode(record.scheduleTimeSlot.finish));
                row.insertCell().appendChild(document.createTextNode(record.executionTimeSlot.start));
                row.insertCell().appendChild(document.createTextNode(record.executionTimeSlot.finish));
            })
        }
        
        function getTasksChartData(rawData)
        {
            const configuration = {
                total:
                {
                    color: '#d7d7d7',
                    label: "Total time in system"
                },
                scheduled:
                {
                    color: '#ffcf92',
                    label: "Scheduled slot"
                },
                executed:
                {
                    color: 'rgb(156,78,78)',
                    label: "Executed slot"
                }
            };
            
            let chartData = {
                labels: [],
                datasets: [
                    {
                        data: [],
                        backgroundColor: [ configuration.total.color ],
                        host: [],
                        label: configuration.total.label,
                        order: 2
                    },
                    {
                        data: [],
                        backgroundColor: [ configuration.scheduled.color ],
                        host: [],
                        label: configuration.scheduled.label,
                        order: 1
                    },
                    {
                        data: [],
                        backgroundColor: [ configuration.executed.color ],
                        host: [],
                        label: configuration.executed.label,
                        order: 0
                    }
                ]
            };
            
            var tasksData = data.sort((a,b) => a.jobId - b.jobId);
            tasksData.forEach(record => {
                chartData.labels.push(`Job ${record.jobId}`);
                
                chartData.datasets[0].host.push(record.jobId);
                chartData.datasets[0].data.push([record.incoming, Math.max(record.executionTimeSlot.finish, record.scheduleTimeSlot.finish)]);
                
                chartData.datasets[1].host.push(record.jobId);
                chartData.datasets[1].data.push([record.scheduleTimeSlot.start, record.scheduleTimeSlot.finish]);
                
                chartData.datasets[2].host.push(record.jobId);
                chartData.datasets[2].data.push([record.executionTimeSlot.start, record.executionTimeSlot.finish]);
            })
            
            return chartData;
        }

        function getPrintersChartData(rawData)
        {
            const printerIds = [...new Set(rawData.map(r => r.printerId).sort((a, b) => a - b))]
            let chartData = {
                labels: printerIds.map(i => `Printer ${i}`),
                datasets: []
            };

            function getRandomColor() {
                var letters = '0123456789ABCDEF';
                var color = '#';
                for (var i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }
            
            for(const job of rawData)
            {
                chartData.datasets[job.jobId - 1] = {
                    data: [],
                    backgroundColor: [ getRandomColor() ],
                    label: `Task ${job.jobId}`,
                };

                chartData.datasets[job.jobId - 1].data[job.printerId - 1] = [job.executionTimeSlot.start, job.executionTimeSlot.finish];
            }

            console.log(chartData)

            return chartData;
        }

        generateTable(data);
        
        new Chart(document.getElementById('tasks-dashboard'), {
            type: 'bar',
            data: getTasksChartData(data),
            
            options: {
                indexAxis: "y",
                scales: {
                    y: {
                        stacked: true
                    }
                },
                chartArea: {
                    backgroundColor: "#FEF8F8"
                },
                legend: {
                    display: false
                }
            }
        });

         new Chart(document.getElementById('printers-dashboard'), {
            type: 'bar',
            data: getPrintersChartData(data),

            options: {
                indexAxis: "y",
                scales: {
                    y: {
                        stacked: true
                    }
                },
                chartArea: {
                    backgroundColor: "#FEF8F8"
                },
                legend: {
                    display: false
                }
            }
        });
    </script>
</body>
</html>